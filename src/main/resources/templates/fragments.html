<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org/">
<head th:fragment="head">
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>Watchlist</title>

    <link href="https://stackpath.bootstrapcdn.com/bootswatch/4.4.1/darkly/bootstrap.min.css" rel="stylesheet" integrity="sha384-rCA2D+D9QXuP2TomtQwd+uP50EHjpafN+wruul0sXZzX/Da7Txn4tB9aLMZV4DZm" crossorigin="anonymous">
    <link href="/css/styles.css" rel="stylesheet" type="text/css" >

</head>
<body>

<header th:fragment="header">
    <h3 th:text="${title}"></h3>
</header>

<nav th:fragment="navbar" class="navbar navbar-expand-lg navbar-dark bg-dark navbar-inverse sticky-top">
    <a class="navbar-brand" th:href="@{/}">Watchlist</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav">
            <li class="nav-item active">
                <a class="nav-link" th:href="@{/search}">Search TMDb.org</a>
            </li>
            <li th:if="${user != null}" class="nav-item">
                <a class="nav-link" th:href="@{/user/{username}(username=${user.username})}">My Watchlist</a>
            </li>
        </ul>
    </div>
    <div class="collapse navbar-collapse" id="navbarText">
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse d-flex justify-content-end" id="navbarNavAltMarkup">
            <div th:if="${user != null}" class="navbar-nav">
                <a class="nav-item nav-link" th:href="@{/user/manage}"><span th:text="${'Hello, ' + user.username + '!'}"></span></a>
                <a class="nav-item nav-link" th:href="@{/logout}">Logout</a>
            </div>
            <div th:unless="${user != null}" class="navbar-nav">
                <a class="nav-item nav-link" th:href="@{/register}">Register</a>
                <a class="nav-item nav-link" th:href="@{/login}">Login</a>
            </div>
        </div>
    </div>
</nav>

<div th:fragment="errors">
    <p th:each="error : ${errorMessages}" th:text="${error}" style="color : red"></p>
</div>

<div th:fragment="messages" class="container-fluid">
    <div th:if="${message != null}"
         th:with="parts=${#strings.arraySplit(message, '|')}"
         th:attr="class=${'alert alert-dismissible alert-' + parts[0]}"
         role="alert">
        <button type="button" class="close" data-dismiss="alert">&times;</button>
        <div th:text="${parts[1]}"></div>
    </div>
</div>

<th:block th:fragment="movielist" th:if="${movies != null}">
    <hr>
    <div th:replace="fragments :: errors"></div>
    <p th:if="${searchTerm != null}" th:text="${'Showing results ' + first + ' - ' + (first + movies.size()) + ' of ' + moviecount + ' for: ' + searchTerm}"></p>
    <div class="row">
        <table class="table table-striped table-hover search-results">
            <tr th:each="movie : ${movies}">
                <td class="search-results-poster">
                    <img th:src="${movie.getPosterPath() != null ? url + movie.getPosterPath() :'/images/filmposterdefault.jpg'}" alt />
                </td>
                <td>
                    <a th:if="${!isUserList}" th:href="@{/movie/tmdb/{id}(id=${movie.id})}"><H4 th:text="${movie.title + ' ' + movie.releaseDate}"></H4></a>
                    <a th:unless="${!isUserList}" th:href="@{/movie/{id}(id=${movie.id})}"><H4 th:text="${movie.title + ' ' + movie.releaseYear}"></H4></a>
                    <em th:if="${movie.crew != null and !movie.crew.isEmpty()}">Directed by <th:block th:each="crew : ${movie.crew}">
                        <span th:text="${crewStat.last ? crew.name : crew.name + ', '}"></span>
                    </th:block>
                    </em>
                    <p style="font-size: 0.75em;" th:text="${#strings.abbreviate(movie.overview,400)}"></p>
                </td>
                <td>
                    <th:block th:if="${user != null}">
                        <a th:if="${!isUserList}" class="btn btn-primary" th:href="@{/watchlist/add(id=${movie.id})}">Add to Watchlist</a>
                        <a th:if="${isUserList and user.id == movie.user.id}" class="btn btn-danger" th:href="@{/watchlist/remove(id=${movie.id})}">Remove from Watchlist</a>
                    </th:block>

                </td>
            </tr>
        </table>
    </div>
</th:block>

<div th:fragment="mainMovieInfo" class="col-md-10 main-film-top-margin">
    <div class="row">
        <div class="col-md-4 poster">
            <div class="center-block">
                <img th:src="${movie.posterPath != null ? url + movie.posterPath :'/images/filmposterdefault.jpg'}" class="img-fluid" alt/>
            </div>
        </div>
        <div class="col-md-8">
            <div class="row main-film-info margin-right-offset" style="border-bottom:3px groove gray">
                <div class="col-md-8">
                    <h1>
                        <span style="color: ghostwhite;" th:text="${movie.title}"></span> <small th:text="${isUserMovie? movie.releaseYear : movie.releaseDate}"></small>
                    </h1>
                </div>
                <div class="col-md-4">
                    <div th:if="${isUserMovie and user.id == movie.user.id}" class="row">
                        <a class="btn btn-danger" th:href="@{/watchlist/remove(id=${movie.id})}">Remove From Watchlist</a>
                    </div>
                    <div th:unless="${isUserMovie and user.id == movie.user.id}" class="row">
                        <a th:if="${!isUserMovie}" class="btn btn-primary" th:href="@{/watchlist/add(id=${movie.id})}">Add To Watchlist</a>
                        <a th:if="${isUserMovie and user.id != movie.user.id}" class="btn btn-primary" th:href="@{/watchlist/add(id=${movie.tmdbId})}">Add To Watchlist</a>
                    </div>
                </div>
            </div>
            <div th:if="${!movie.overview.isEmpty()}" class="row main-film-info">
                <h2>Synopsis</h2>
                <p th:text="${movie.overview}"></p>
                <br />
            </div>
            <div th:if="${movie.cast.size() > 0}" class="row main-film-info">
                <h2>Top Cast Members</h2>
            </div>
            <div class="row">
                <div th:each="castMember : ${movie.cast}" th:if="${castMemberStat.index < 10}" class="col-md-4 cast-display">
                    <a th:if="${!isUserMovie}" th:href="${'https://www.themoviedb.org/person/' + castMember.id}" th:text="${castMember.name}"></a>
                    <a th:unless="${!isUserMovie}" th:href="${'https://www.themoviedb.org/person/' + castMember.castId}" th:text="${castMember.name}"></a>
                </div>
            </div>
            <div th:if="${comments != null}" class="row main-film-info">
                <h2 th:text="${'Comments from ' + user.username}"></h2>
                <p th:text="${movie.getComments()}"></p>
            </div>
        </div>
    </div>
    <br />
    <div th:if="${trailerUrl != null}" class="row embed-responsive embed-responsive-16by9 margin-right-offset">
        <iframe class="embed-responsive-item" th:src="${trailerUrl}" frameborder="0" allowfullscreen></iframe>
    </div>
</div>

<div th:fragment="secondaryInfo" class="col-md-2 extra-film-info">
    <div th:replace="fragments :: userInfo"></div>
    <hr />
    <div class="film-stats">
        <div class="row">
            <b>Directed By:</b>
            <th:block th:if="${isUserMovie}">
                <p th:each="director : ${movie.directors}" th:text="${director.name}"></p>
            </th:block>
            <th:block th:unless="${isUserMovie}">
                <p th:each="crew : ${movie.crew}" th:text="${crew.name}"></p>
            </th:block>
        </div>
        <div class="row">
            <b>Runtime:</b>
            <p th:text="${movie.runtime == 0 ? 'unknown' : movie.runtime + ' min.'}"></p>
        </div>
        <div class="row" th:if="${movie.genres != null and !movie.genres.isEmpty()}" >
            <h6 class="w-100">Genres:</h6>
            <ul>
                <li th:each="genre : ${movie.genres}" th:text="${genre.name}"></li>
            </ul>
        </div>
    </div>
</div>

<div th:fragment="userInfo">
    <div class="row profilePicture">
        <img class="img-fluid rounded mx-auto d-block" id="profile-picture" src="../static/images/profilepictures/defaultProfilePicture.png" th:src="@{${'/images/profilepictures/' + user.profilePicturePath}}">
    </div>
    <H4 class="center-text" th:text="${user.username}"></H4>
    <div class="row center-text" id="user-links">
        <a th:href="@{${'/user/' + user.username}}">Watchlist</a>
    </div>
</div>

<div th:fragment="upcoming">
    <h4 class="center-text">Coming Soon</h4>
    <table class="table-list">
        <tr>
            <th>Title</th>
            <th>Release</th>
        </tr>
        <tr th:each="movie : ${upcoming}">
            <td><a th:if="${!isUserList}" th:href="@{${'/movie/tmdb/' + movie.id}}" th:text="${movie.title}"></a>
                <a th:unless="${!isUserList}" th:href="@{${'/movie/' + movie.id}}" th:text="${movie.title}"></a>
            </td>
            <td th:text="${movie.releaseDate}"></td>
        </tr>
    </table>
</div>

<th:block th:fragment="scripts">
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
</th:block>

</body>
</html>